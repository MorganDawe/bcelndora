---
id: bceln_mads_to_term_person
label: Create terms in the Person taxonomy.
migration_group: foxml_to_dgis
source:
  plugin: dgi_migrate.source.migration
  track_changes: true
  migration: dgis_foxml_files
  dsf_misc:
    case_insensitive: &case_insensitive true
    base_mads_node: &base_mads_node
      plugin: dgi_migrate.process.xml.context_query
      missing_behavior: skip_process
      source: '@_mads_node'
      xpath: '@_mads_xpath'
    nested_mads_node: &nested_mads_node
      plugin: dgi_migrate.process.xml.context_query
      source: 'parent_value'
      xpath: 'parent_row/dest/_mads_xpath'

destination:
  plugin: entity:taxonomy_term
  default_bundle: person
  validate: true

process:
  _node_foxml_parsed:
    - plugin: dgi_migrate.load_entity
      source: fid
      entity_type: entity:file
    - plugin: dgi_migrate.method
      method: getFileUri
    - plugin: foxml.parse
  _models:
    - plugin: dgi_migrate.method
      source: '@_node_foxml_parsed'
      method: models
    - plugin: skip_on_empty
      method: row
  _mads_xpath:
    - plugin: dgi_migrate.subindex
      index: 'MADS'
      source: '@_node_foxml_parsed'
      missing_behavior: skip_process
    - plugin: dgi_migrate.method
      method: getUri
    # XXX: An issue in the passing off of paths/URIs to libxml prevents the use
    # of "dgi_migrate.process.xml.domfile"
    - plugin: callback
      callable: file_get_contents
    - plugin: dgi_migrate.process.xml.domstring
      missing_behavior: skip_process
    - plugin: dgi_migrate.process.xml.xpath
      namespaces:
        mods: 'http://www.loc.gov/mads/v2'
        xsi: 'http://www.w3.org/2001/XMLSchema-instance'
        xlink: 'http://www.w3.org/1999/xlink'
  _mads_node:
    - plugin: skip_on_empty
      method: process
      source: '@_mads_xpath'
    - plugin: dgi_migrate.method
      method: query
      args:
        - '//mads:mads[1]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: array_shift
  _family_name:
    - << : *base_mads_node
      query: 'mads:authority/mads:name'
    - plugin: callback
      callable: iterator_to_array
    - plugin: skip_on_empty
      method: row
    - plugin: multiple_values
    - plugin: dgi_migrate.sub_process
      process_values: true
      values:
        _family:
          - << : *nested_mads_node
            query: 'normalize-space(mads:namePart[@type="family"][normalize-space()][1])'
            method: evaluate
          - plugin: skip_on_empty
            method: process
    - plugin: skip_on_empty
      method: process
    - plugin: dgi_migrate.process.single_extract
      index: [ _family ]
  _given_name:
    - << : *base_mads_node
      query: 'mads:authority/mads:name'
    - plugin: callback
      callable: iterator_to_array
    - plugin: skip_on_empty
      method: row
    - plugin: multiple_values
    - plugin: dgi_migrate.sub_process
      process_values: true
      values:
        _given:
          - << : *nested_mads_node
            query: 'normalize-space(mads:namePart[@type="given"][normalize-space()][1])'
            method: evaluate
          - plugin: skip_on_empty
            method: process
    - plugin: skip_on_empty
      method: process
    - plugin: dgi_migrate.process.single_extract
      index: [ _given ]
  _name_date:
    - << : *base_mads_node
      query: 'mads:authority/mads:name'
    - plugin: callback
      callable: iterator_to_array
    - plugin: skip_on_empty
      method: row
    - plugin: multiple_values
    - plugin: dgi_migrate.sub_process
      process_values: true
      values:
        _date:
          - << : *nested_mads_node
            query: 'normalize-space(mads:namePart[@type="date"][normalize-space()][1])'
            method: evaluate
          - plugin: skip_on_empty
            method: process
    - plugin: skip_on_empty
      method: process
    - plugin: dgi_migrate.process.single_extract
      index: [ _date ]
  status:
    - plugin: dgi_migrate.subproperty
      source: '@_node_foxml_parsed'
      property: state
    - plugin: static_map
      map:
        'Active': 1
        'Inactive': 0
        'Deleted': 0
  name:
    - plugin: get
      source:
        - '@_family_name'
        - '@_given_name'
        - '@_name_date'
    - plugin: flatten
    - plugin: callback
      callable: array_filter
    - plugin: concat
      delimiter: ', '
    - plugin: skip_on_empty
      method: row
  # TODO: add 'tid' if a term with the same 'name' value exists.
  field_person_preferred_name/family:
    - plugin: get
      source: '@_family_name'
    - plugin: skip_on_empty
      method: process
    - plugin: flatten
    - plugin: null_coalesce
  field_person_preferred_name/given:
    - plugin: get
      source: '@_given_name'
    - plugin: skip_on_empty
      method: process
    - plugin: flatten
    - plugin: null_coalesce
  # TODO: add field_person_email_contact
  # TODO: add field_phone
  # TODO: add field_person_department (entity reference to term in vocab: discipline)
  # TODO: add field_position
  # TODO: add field_affiliation_date (EDTF date range)
  # TODO: add field_description (two possible mapping sources)
  # TODO: add field_address
  # TODO: add field_status
  # TODO: add field_orcid
  # TODO: add field_field_of_activity
  # TODO: add field_identifier_other
  # TODO: add field_person_alternate_names/family
  # TODO: add field_person_alternate_names/given
  # TODO: add field_photograph (entity reference to Image Media)

migration_dependencies:
  required:
    - dgis_foxml_files

dependencies:
  enforced:
    module:
      - dgi_migrate
      - dgi_migrate_foxml_standard_mods
