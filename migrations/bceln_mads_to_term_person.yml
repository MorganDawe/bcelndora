---
id: bceln_mads_to_term_person
label: Create terms in the Person taxonomy.
migration_group: foxml_to_dgis
source:
  plugin: dgi_migrate.source.migration
  track_changes: true
  migration: dgis_foxml_files
  dsf_misc:
    case_insensitive: &case_insensitive true
    base_mads_node: &base_mads_node
      plugin: dgi_migrate.process.xml.context_query
      missing_behavior: skip_process
      source: '@_mads_node'
      xpath: '@_mads_xpath'
    nested_mads_node: &nested_mads_node
      plugin: dgi_migrate.process.xml.context_query
      source: 'parent_value'
      xpath: 'parent_row/dest/_mads_xpath'

destination:
  plugin: entity:taxonomy_term
  default_bundle: person
  validate: true

process:
  _node_foxml_parsed:
    - plugin: dgi_migrate.load_entity
      source: fid
      entity_type: entity:file
    - plugin: dgi_migrate.method
      method: getFileUri
    - plugin: foxml.parse
  _models:
    - plugin: dgi_migrate.method
      source: '@_node_foxml_parsed'
      method: models
    - plugin: skip_on_empty
      method: row
  _mads_xpath:
    - plugin: dgi_migrate.subindex
      index: 'MADS'
      source: '@_node_foxml_parsed'
      missing_behavior: skip_process
    - plugin: dgi_migrate.method
      method: getUri
    # XXX: An issue in the passing off of paths/URIs to libxml prevents the use
    # of "dgi_migrate.process.xml.domfile"
    - plugin: callback
      callable: file_get_contents
    - plugin: dgi_migrate.process.xml.domstring
      missing_behavior: skip_process
    - plugin: dgi_migrate.process.xml.xpath
      namespaces:
        mods: 'http://www.loc.gov/mads/v2'
        xsi: 'http://www.w3.org/2001/XMLSchema-instance'
        xlink: 'http://www.w3.org/1999/xlink'
  _mads_node:
    - plugin: skip_on_empty
      method: process
      source: '@_mads_xpath'
    - plugin: dgi_migrate.method
      method: query
      args:
        - '//mads:mads[1]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: array_shift
  status:
    - plugin: dgi_migrate.subproperty
      source: '@_node_foxml_parsed'
      property: state
    - plugin: static_map
      map:
        'Active': 1
        'Inactive': 0
        'Deleted': 0
  name:
    - << : *base_mads_node
      query: 'mads:authority/mads:name'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: null_coalesce

migration_dependencies:
  required:
    - dgis_foxml_files

dependencies:
  enforced:
    module:
      - dgi_migrate
      - dgi_migrate_foxml_standard_mods
